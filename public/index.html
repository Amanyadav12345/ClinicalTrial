<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TrialTrack ‚Äì Tracks trials and patients in real-time</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #aiResponse h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-top: 1.5rem;
      margin-bottom: 1rem;
      color: #1e3a8a;
    }
    #aiResponse h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-top: 1.25rem;
      margin-bottom: 0.75rem;
      color: #334155;
    }
    #aiResponse ul, #aiResponse ol {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }
    #aiResponse table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.95rem;
    }
    #aiResponse th, #aiResponse td {
      border: 1px solid #d1d5db;
      padding: 8px 12px;
      text-align: left;
    }
    #aiResponse th {
      background-color: #f1f5f9;
      font-weight: 600;
    }
    #aiResponse p {
      margin-bottom: 1rem;
    }
    #aiResponse pre {
      background-color: #f3f4f6;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-gray-100 text-gray-800 font-sans min-h-screen flex">

  <!-- Sidebar -->
  <aside class="w-72 bg-white shadow-md p-4 overflow-y-auto">
    <h2 class="text-xl font-bold text-blue-700 mb-4">üìÅ Previous Trials</h2>
    <ul id="historyList" class="space-y-2 text-sm text-gray-700">Loading...</ul>
  </aside>

  <!-- Main Content -->
   <div class="absolute top-4 right-4 z-50">
  <button onclick="openChemistryLab()"
          class="bg-purple-600 hover:bg-purple-700 text-white text-xl rounded-full w-10 h-10 flex items-center justify-center shadow-md transition">
    üß™ 
  </button>
</div>
  <main class="flex-1 p-6 flex justify-center">

    <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-4xl space-y-6">
      <h2 class="text-3xl font-bold text-center text-blue-700">TrialTrack ‚Äì Tracks trials and patients in real-time</h2>

      <form id="trialForm" class="space-y-5">
        <input type="text" name="disease" placeholder="Disease" required
               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"/>
        <input list="trialPhases" name="phase" placeholder="Trial Phase" required
        class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"/>

                <datalist id="trialPhases">
                  <option value="Phase 0">
                  <option value="Phase 1">
                  <option value="Phase 2">
                  <option value="Phase 3">
                  <option value="Phase 4">
                </datalist>
        <input list="countryList" name="region" placeholder="Region" required
         class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"/>
        <datalist id="countryList"></datalist>
        <input type="text" name="endpoints" placeholder="Endpoints (comma-separated)" required
               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"/>
        <input type="text" name="duration" placeholder="Duration (e.g., 12 months)" required
               class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"/>

        <button type="submit"
                class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 transition duration-200">
          Submit Trial
        </button>
      </form>

      <div class="mt-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">AI Recommendation:</h3>
        <div id="aiResponse"
             class="bg-white p-6 rounded-md shadow border text-gray-800 prose max-w-none overflow-auto max-h-[600px]">
          <p>No response yet.</p>
        </div>

        <button onclick="printResponse()"
                class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200">
          Download Recommendation
        </button>
        <button onclick="document.getElementById('patientUpload').click()"
                class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-200">
          Upload Patient List
        </button>
        <input type="file" id="patientUpload" accept=".csv" class="hidden" />

        <!-- Eligibility Table -->
        <div id="patientResult" class="mt-6 hidden overflow-auto max-h-[600px] bg-white p-6 rounded-md shadow border">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Patient Eligibility Check</h3>
          <table class="w-full text-sm text-left border border-collapse border-gray-300">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-4 py-2">Patient Name</th>
                <th class="border px-4 py-2">Age</th>
                <th class="border px-4 py-2">Region</th>
                <th class="border px-4 py-2">Medical History</th>
                <th class="border px-4 py-2">Eligible</th>
              </tr>
            </thead>
            <tbody id="patientTableBody"></tbody>
          </table>
        </div>
        <button id="filterEligibleBtn"
                  class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200 hidden">
            Show Only Eligible Patients
          </button>
          <button id="openDashboardBtn"
                  class="mt-4 ml-4 bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 transition duration-200 hidden"
                  onclick="window.open('dashboard.html', '_blank')">
            Open Monitoring Dashboard
          </button>
      </div>
    </div>
  </main>

  <script>
    const form = document.getElementById('trialForm');
    const responseEl = document.getElementById('aiResponse');
    async function loadCountries() {
      const res = await fetch('https://restcountries.com/v3.1/all');
      const countries = await res.json();
      const datalist = document.getElementById('countryList');

      countries
        .map(c => c.name.common)
        .sort()
        .forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          datalist.appendChild(option);
        });
    }

    loadCountries();


      function openChemistryLab() {
        window.open('chemistry-lab.html', '_blank');
      }


    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const data = Object.fromEntries(formData);

      responseEl.innerHTML = "<p class='italic text-gray-500'>üß† Making your trial based on past studies...</p>";

      try {
        const res = await fetch('/submit-trial', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        let content = result.message || "<p>No AI response received.</p>";

        if (content.startsWith("```html")) {
          content = content.replace(/^```html\s*/, "").replace(/```$/, "");
        }

        responseEl.innerHTML = content;
        await loadTrialHistory(); // refresh sidebar
      } catch (err) {
        responseEl.innerHTML = "<p class='text-red-500'>‚ùå Error fetching AI response.</p>";
      }
    });

    function printResponse() {
      const content = document.getElementById('aiResponse').innerHTML;
      const printWindow = window.open('', '', 'width=800,height=600');
      printWindow.document.write(`
        <html><head><title>AI Trial Recommendation</title>
        <style>body{font-family:Arial;padding:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:8px;}h2,h3{color:#333;}ul,ol{margin-left:20px;}</style>
        </head><body>${content}</body></html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    document.getElementById('patientUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const csv = event.target.result;
        const rows = csv.split("\n").slice(1);
        const output = [];

        const selectedDisease = document.querySelector('input[name="disease"]').value.trim().toLowerCase();

        rows.forEach(row => {
          const fields = row.split(",");
          if (fields.length < 4) return; // Skip if row doesn't have all 4 values

          const [name, age, region, historyRaw] = fields;
          const history = historyRaw.trim().toLowerCase();
          const ageNum = parseInt(age);
          const regionClean = region.trim().toLowerCase();

          // Disease check
          const hasTargetDisease = history.includes(selectedDisease);

          // Exclusion logic
          const hasCriticalComorbidity =
            history.includes("renal") ||
            history.includes("hepatic") ||
            history.includes("cardiovascular");

          const isEligible =
            hasTargetDisease &&
            ageNum >= 18 && ageNum <= 65 &&
            !hasCriticalComorbidity;

          output.push({
            name: name.trim(),
            age: ageNum,
            region: regionClean,
            history,
            eligible: isEligible ? '‚úÖ Yes' : '‚ùå No'
          });
        });
        const tbody = document.getElementById('patientTableBody');
        tbody.innerHTML = '';
        output.forEach(p => {
          tbody.innerHTML += `
            <tr>
              <td class="border px-4 py-2">${p.name}</td>
              <td class="border px-4 py-2">${p.age}</td>
              <td class="border px-4 py-2">${p.region}</td>
              <td class="border px-4 py-2">${p.history}</td>
              <td class="border px-4 py-2">${p.eligible}</td>
            </tr>
          `;
        });

        const eligibleOnly = output.filter(p => p.eligible === '‚úÖ Yes');
        localStorage.setItem('eligiblePatients', JSON.stringify(eligibleOnly));

        document.getElementById('patientResult').classList.remove('hidden');
        document.getElementById('filterEligibleBtn').classList.remove('hidden');
        document.getElementById('openDashboardBtn').classList.remove('hidden');
      };

      reader.readAsText(file);
    });

    document.getElementById('filterEligibleBtn').addEventListener('click', () => {
      const rows = document.querySelectorAll('#patientTableBody tr');
      rows.forEach(row => {
        const eligibility = row.cells[4].textContent.trim();
        row.style.display = eligibility === '‚úÖ Yes' ? '' : 'none';
      });
    });

    async function loadTrialHistory() {
      const res = await fetch('/history');
      const data = await res.json();
      const container = document.getElementById('historyList');
      container.innerHTML = '';

      data.forEach(trial => {
        const li = document.createElement('li');
        li.className = 'cursor-pointer hover:underline';
        li.textContent = `${trial.disease} ‚Äì ${trial.phase} (${trial.region})`;
        li.onclick = () => {
          ['disease', 'phase', 'region', 'endpoints', 'duration'].forEach(key => {
            document.querySelector(`[name="${key}"]`).value = trial[key];
          });
          document.getElementById('aiResponse').innerHTML = trial.ai_output || "<p>No saved AI output.</p>";
        };
        container.appendChild(li);
      });
    }

    // Load on page load
    loadTrialHistory();
  </script>
</body>
</html>
