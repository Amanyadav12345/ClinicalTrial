<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Compliance Document Upload</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
  <div class="bg-white shadow-lg rounded-xl p-8 max-w-2xl w-full space-y-6">
    <h1 class="text-2xl font-bold text-blue-700">üìÑ Compliance Document Upload</h1>
    <p class="text-gray-600">Upload SOPs, validation protocols, audit logs, or other relevant documents. AI will analyze them and suggest improvements for regulatory compliance.</p>

    <form id="complianceForm" class="space-y-4">
      <input type="file" name="docs" multiple accept=".pdf,.doc,.docx" required class="block w-full border p-2 rounded" />
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
        Upload and Analyze
      </button>
    </form>

    <div id="resultArea" class="hidden mt-6 bg-gray-100 p-4 rounded border border-gray-300 text-sm text-gray-800"></div>
    <div id="scorecard" class="hidden mt-4 bg-white border border-gray-300 rounded p-4"></div>
  </div>

  <script>
    document.getElementById('complianceForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      const res = await fetch('/analyze-compliance-docs', {
        method: 'POST',
        body: formData
      });

      const resultArea = document.getElementById('resultArea');
      const scorecard = document.getElementById('scorecard');

      if (res.ok) {
        const data = await res.json();
        resultArea.classList.remove('hidden');
        resultArea.innerHTML = `<h2 class="font-bold mb-2">AI Feedback:</h2><p>${data.feedback}</p>`;

        // Scorecard logic
        const scoreData = [
          {
            category: "Validation Protocol",
            score: 30,
            max: 40,
            remark: "Partially complete; include full IQ/OQ/PQ structure"
          },
          {
            category: "Audit Trail",
            score: 20,
            max: 30,
            remark: "Basic present; enhance with append-only timestamps"
          },
          {
            category: "Access Control Policy",
            score: 10,
            max: 30,
            remark: "Missing or insufficient details"
          }
        ];

        const totalScore = scoreData.reduce((sum, item) => sum + item.score, 0);
        const totalMax = scoreData.reduce((sum, item) => sum + item.max, 0);

        let tableHTML = `
          <h2 class="text-lg font-bold text-blue-700 mb-2">üìä 21 CFR Part 11 / Annex 11 / GxP Compliance Scorecard </h2>
          <table class="w-full text-sm border border-collapse mt-2">
            <thead class="bg-gray-200">
              <tr>
                <th class="border px-4 py-2 text-left">Category</th>
                <th class="border px-4 py-2 text-left">Score</th>
                <th class="border px-4 py-2 text-left">Remarks</th>
              </tr>
            </thead>
            <tbody>`;

        scoreData.forEach(item => {
          tableHTML += `
            <tr>
              <td class="border px-4 py-2">${item.category}</td>
              <td class="border px-4 py-2">${item.score} / ${item.max}</td>
              <td class="border px-4 py-2">${item.remark}</td>
            </tr>`;
        });

        tableHTML += `
          <tr class="bg-yellow-100 font-bold">
            <td class="border px-4 py-2">Total</td>
            <td class="border px-4 py-2">${totalScore} / ${totalMax}</td>
            <td class="border px-4 py-2">Overall: ${totalScore >= 80 ? '‚úÖ Strong' : totalScore >= 60 ? '‚ö†Ô∏è Moderate' : '‚ùå Weak'} compliance</td>
          </tr>
        </tbody></table>`;

        scorecard.classList.remove('hidden');
        scorecard.innerHTML = tableHTML;

      } else {
        resultArea.classList.remove('hidden');
        resultArea.innerHTML = `<p class="text-red-600">Failed to analyze documents. Please try again.</p>`;
      }
    });
  </script>
</body>
</html>
