<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Patient Monitoring Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-geo@3.9.0/build/index.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/world-atlas/countries-50m.json"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-geo@3.9.0/build/index.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800 font-sans min-h-screen p-6">
  <h1 class="text-3xl font-bold text-center text-blue-700 mb-6"> Patient Monitoring Dashboard</h1>

  <!-- Section: Charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Age Distribution</h2>
      <div class="h-72">
        <canvas id="ageChart"></canvas>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Region Heatmap (World)</h2>
      <div class="h-72">
        <canvas id="regionMapChart"></canvas>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Medical History Breakdown</h2>
      <div class="h-72">
        <canvas id="historyChart"></canvas>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Eligibility Ratio</h2>
      <div class="h-72">
        <canvas id="eligibilityChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Section: Eligible Patients List -->
  <div class="bg-white p-6 rounded-lg shadow mt-8">
    <h2 class="text-xl font-semibold mb-4">Eligible Patients</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-left border border-collapse border-gray-300">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-4 py-2">Name</th>
            <th class="border px-4 py-2">Age</th>
            <th class="border px-4 py-2">Region</th>
            <th class="border px-4 py-2">Medical History</th>
          </tr>
        </thead>
        <tbody id="patientTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    window.onload = () => {
      const patients = JSON.parse(localStorage.getItem('eligiblePatients')) || [];
      const tableBody = document.getElementById('patientTable');
      const ageGroups = ['18-25', '26-35', '36-45', '46-55', '56-65', '66+'];
      const ageData = [0, 0, 0, 0, 0, 0];
      const regionDataMap = {};
      const historyDataMap = {};

      patients.forEach(p => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="border px-4 py-2">${p.name}</td>
          <td class="border px-4 py-2">${p.age}</td>
          <td class="border px-4 py-2">${p.region}</td>
          <td class="border px-4 py-2">${p.history}</td>
        `;
        tableBody.appendChild(row);

        const age = parseInt(p.age);
        if (age <= 25) ageData[0]++;
        else if (age <= 35) ageData[1]++;
        else if (age <= 45) ageData[2]++;
        else if (age <= 55) ageData[3]++;
        else if (age <= 65) ageData[4]++;
        else ageData[5]++;

        const region = p.region.trim();
        regionDataMap[region] = (regionDataMap[region] || 0) + 1;
          row.addEventListener('click', () => {
          localStorage.setItem('selectedPatientName', p.name);
          window.open('personal-dashboard.html', '_blank');
        });
        const conditions = p.history.split(',');
        conditions.forEach(cond => {
          const key = cond.trim().toLowerCase();
          if (key) historyDataMap[key] = (historyDataMap[key] || 0) + 1;
        });
      });

      const historyLabels = Object.keys(historyDataMap);
      const historyCounts = Object.values(historyDataMap);

      new Chart(document.getElementById('ageChart'), {
        type: 'bar',
        data: {
          labels: ageGroups,
          datasets: [{
            label: 'Number of Patients',
            data: ageData,
            backgroundColor: 'rgba(59, 130, 246, 0.7)'
          }]
        }
      });

      new Chart(document.getElementById('historyChart'), {
        type: 'bar',
        data: {
          labels: historyLabels,
          datasets: [{
            label: 'Conditions',
            data: historyCounts,
            backgroundColor: 'rgba(16, 185, 129, 0.7)'
          }]
        },
        options: {
          indexAxis: 'y'
        }
      });

      new Chart(document.getElementById('eligibilityChart'), {
        type: 'pie',
        data: {
          labels: ['Eligible', 'Not Eligible'],
          datasets: [{
            label: 'Eligibility',
            data: [patients.length, localStorage.getItem('nonEligibleCount') || 0],
            backgroundColor: ['#10b981','#f87171']
          }]
        }
      });
fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json')
  .then(res => res.json())
  .then(worldData => {
    const countries = ChartGeo.topojson.feature(worldData, worldData.objects.countries).features;

    const regionCounts = Object.entries(regionDataMap).map(([region, count]) => {
      const match = countries.find(
        f => f.properties.name.toLowerCase() === region.trim().toLowerCase()
      );
      return match ? { feature: match, value: count } : null;
    }).filter(Boolean);

    const mapCanvas = document.getElementById('regionMapChart');
    new Chart(mapCanvas, {
      type: 'choropleth',
      data: {
        labels: regionCounts.map(d => d.feature.properties.name),
        datasets: [{
          label: 'Patients by Country',
          data: regionCounts,
          outline: {
            color: '#ffffff',
            width: 0.5
          },
          borderColor: '#ffffff',
          borderWidth: 0.5,
          backgroundColor: (ctx) => {
            const value = ctx.raw?.value || 0;
            const alpha = Math.min(0.2 + value / 50, 1);
            return `rgba(37,99,235,${alpha})`;
          }
        }]
      },
      options: {
        showOutline: true,
        showGraticule: false,
        scales: {
          projection: {
            axis: 'x',
            projection: 'equalEarth'
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.label}: ${ctx.raw.value} patients`
            }
          },
          legend: { display: false }
        }
      }
    });
  });
    }
     </script>
</body>
</html>
